{"version":3,"sources":["file:///D:/Tower-Run/Tower-Run/assets/Scripts/Block.ts"],"names":["_decorator","Component","BoxCollider","find","RigidBody","director","GameManager","ccclass","property","Block","start","_parentNode","isPlayerNodeChild","node","isChildOf","collider","getComponent","on","_onCollisionEnter","event","otherCollider","name","otherBlock","otherBlockComp","emit","InGameState","STOP_MOVING","curParentPos","getPosition","LOAD_SCORE","setPosition","x","y","z","setParent","START_MOVING","selfWorldPos","getWorldPosition","otherBlockWorldPos","selfWorldPosY","Math","floor","otherBlockWorldPosY","abs","rigidBody","sleep","scheduleOnce","destroy"],"mappings":";;;;;;;;;;;;;;;;AACSA,MAAAA,U,OAAAA,U;AAAYC,MAAAA,S,OAAAA,S;AAAiBC,MAAAA,W,OAAAA,W;AAAmCC,MAAAA,I,OAAAA,I;AAAYC,MAAAA,S,OAAAA,S;AAAWC,MAAAA,Q,OAAAA,Q;;AACvFC,MAAAA,W,gBAAAA,W;;;;;;;OAEH;AAAEC,QAAAA,OAAF;AAAWC,QAAAA;AAAX,O,GAAwBR,U;;uBAGjBS,K,WADZF,OAAO,CAAC,OAAD,C,yBAAR,MACaE,KADb,SAC2BR,SAD3B,CACqC;AAAA;AAAA;;AAAA,4CAEL,KAFK;;AAAA,qDAIG,KAJH;;AAAA,+CAKL,IALK;AAAA;;AAQjCS,QAAAA,KAAK,GAAG;AACJ,eAAKC,WAAL,GAAmBR,IAAI,CAAC,mBAAD,CAAvB;AACA,eAAKS,iBAAL,GAAyB,KAAKC,IAAL,CAAUC,SAAV,CAAoB,KAAKH,WAAzB,CAAzB;AAEA,cAAII,QAAQ,GAAG,KAAKC,YAAL,CAAkBd,WAAlB,CAAf;AACAa,UAAAA,QAAQ,CAACE,EAAT,CAAY,kBAAZ,EAAgC,KAAKC,iBAArC,EAAwD,IAAxD;AACH;;AAGOA,QAAAA,iBAAiB,CAACC,KAAD,EAAyB;AAC9C,cAAIA,KAAK,CAACC,aAAN,CAAoBC,IAApB,KAA6B,oBAAjC,EAAuD;AAAE;AACrD,gBAAIC,UAAU,GAAGH,KAAK,CAACC,aAAN,CAAoBP,IAArC;AACA,gBAAIU,cAAc,GAAGD,UAAU,CAACN,YAAX,CAAwBP,KAAxB,CAArB;;AAEA,gBAAIc,cAAc,CAACX,iBAAnB,EAAsC;AAAE;AACpC;AAEH,aAHD,MAGO,IAAI,KAAKA,iBAAL,IAA0B,CAACW,cAAc,CAACX,iBAA9C,EAAgE;AAAE;AAErEP,cAAAA,QAAQ,CAACmB,IAAT,CAAc;AAAA;AAAA,8CAAYC,WAAZ,CAAwBC,WAAtC,EAFmE,CAEhB;;AACnD,kBAAIC,YAAkB,GAAG,KAAKhB,WAAL,CAAiBiB,WAAjB,EAAzB,CAHmE,CAGX;;;AACxDvB,cAAAA,QAAQ,CAACmB,IAAT,CAAc;AAAA;AAAA,8CAAYC,WAAZ,CAAwBI,UAAtC,EAAkD,IAAlD,EAAwDF,YAAxD;;AAEA,mBAAKhB,WAAL,CAAiBmB,WAAjB,CAA6BH,YAAY,CAACI,CAA1C,EAA6CJ,YAAY,CAACK,CAAb,GAAiB,GAA9D,EAAmEL,YAAY,CAACM,CAAhF;;AACAX,cAAAA,UAAU,CAACQ,WAAX,CAAuBH,YAAY,CAACI,CAApC,EAAuC,GAAvC,EAA4CJ,YAAY,CAACM,CAAzD;AAEAX,cAAAA,UAAU,CAACY,SAAX,CAAqB,KAAKvB,WAA1B,EAAuC,IAAvC,EATmE,CAStB;;AAC7CY,cAAAA,cAAc,CAACX,iBAAf,GAAmC,IAAnC,CAVmE,CAanE;;AACAP,cAAAA,QAAQ,CAACmB,IAAT,CAAc;AAAA;AAAA,8CAAYC,WAAZ,CAAwBU,YAAtC;AAEH;AAEJ,WAzBD,MAyBO,IAAIhB,KAAK,CAACC,aAAN,CAAoBC,IAApB,KAA6B,oBAAjC,EAAuD;AAAE;AAC5D,gBAAIe,YAAkB,GAAG,KAAKvB,IAAL,CAAUwB,gBAAV,EAAzB;AACA,gBAAIC,kBAAwB,GAAGnB,KAAK,CAACC,aAAN,CAAoBP,IAApB,CAAyBwB,gBAAzB,EAA/B;AAEA,gBAAIE,aAAqB,GAAGC,IAAI,CAACC,KAAL,CAAWL,YAAY,CAACJ,CAAb,GAAiB,EAA5B,IAAkC,EAA9D;AACA,gBAAIU,mBAA2B,GAAGF,IAAI,CAACC,KAAL,CAAWH,kBAAkB,CAACN,CAAnB,GAAuB,EAAlC,IAAwC,EAA1E;;AAEA,gBAAIQ,IAAI,CAACG,GAAL,CAASD,mBAAmB,GAAGH,aAA/B,IAAgD,GAApD,EAAyD;AAAE;AACvD,kBAAIK,SAAS,GAAG,KAAK/B,IAAL,CAAUG,YAAV,CAAuBZ,SAAvB,CAAhB;AACAwC,cAAAA,SAAS,CAACC,KAAV;AACA,mBAAKhC,IAAL,CAAUqB,SAAV,CAAoB/B,IAAI,CAAC,QAAD,CAAxB,EAAoC,IAApC,EAHqD,CAGX;;AAE1C,mBAAK2C,YAAL,CAAkB,MAAM;AAAE;AACtB,qBAAKjC,IAAL,CAAUkC,OAAV;AACH,eAFD,EAEG,CAFH;AAIH,aATD,MASO;AACH;AACH;AACJ;AAEJ;;AAhEgC,O","sourcesContent":["\r\nimport { _decorator, Component, Node, BoxCollider, ICollisionEvent, log, find, Vec3, RigidBody, director, Collider } from 'cc';\r\nimport { GameManager } from './GameManager';\r\nimport { PlayerCtrl } from './PlayerCtrl';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('Block')\r\nexport class Block extends Component {\r\n\r\n    private _isReady: boolean = false\r\n\r\n    public isPlayerNodeChild: boolean = false\r\n    private _parentNode: Node = null!\r\n\r\n\r\n    start() {\r\n        this._parentNode = find(\"Models/PlayerNode\")!\r\n        this.isPlayerNodeChild = this.node.isChildOf(this._parentNode)\r\n\r\n        let collider = this.getComponent(BoxCollider)!\r\n        collider.on('onCollisionEnter', this._onCollisionEnter, this)\r\n    }\r\n\r\n\r\n    private _onCollisionEnter(event: ICollisionEvent) {\r\n        if (event.otherCollider.name === 'block<BoxCollider>') { // 跟方块碰撞\r\n            let otherBlock = event.otherCollider.node\r\n            let otherBlockComp = otherBlock.getComponent(Block)!\r\n\r\n            if (otherBlockComp.isPlayerNodeChild) { // 碰撞方块已经加进父节点，是兄弟节点则不用处理\r\n                return\r\n\r\n            } else if (this.isPlayerNodeChild && !otherBlockComp.isPlayerNodeChild){ // 碰撞方块不是兄弟节点，则加进父节点 \r\n\r\n                director.emit(GameManager.InGameState.STOP_MOVING) // 碰撞开始，PlayerCtrl 停止运动\r\n                let curParentPos: Vec3 = this._parentNode.getPosition() // 碰撞开始时父节点的位置\r\n                director.emit(GameManager.InGameState.LOAD_SCORE, 3000, curParentPos)              \r\n\r\n                this._parentNode.setPosition(curParentPos.x, curParentPos.y + 0.4, curParentPos.z)\r\n                otherBlock.setPosition(curParentPos.x, 0.4, curParentPos.z)\r\n\r\n                otherBlock.setParent(this._parentNode, true) // 设 PlayerNode 为父节点, 一起运动, true 保留当前世界坐标\r\n                otherBlockComp.isPlayerNodeChild = true\r\n                \r\n\r\n                // 碰撞方块加入父节点，碰撞结束，PlayerCtrl 开始运动\r\n                director.emit(GameManager.InGameState.START_MOVING)\r\n                \r\n            }\r\n\r\n        } else if (event.otherCollider.name === 'crate<BoxCollider>') { // 跟木箱碰撞\r\n            let selfWorldPos: Vec3 = this.node.getWorldPosition()\r\n            let otherBlockWorldPos: Vec3 = event.otherCollider.node.getWorldPosition()\r\n            \r\n            let selfWorldPosY: number = Math.floor(selfWorldPos.y * 10) / 10\r\n            let otherBlockWorldPosY: number = Math.floor(otherBlockWorldPos.y * 10) / 10\r\n\r\n            if (Math.abs(otherBlockWorldPosY - selfWorldPosY) < 0.3) { // 方块跟木箱在同一水平面上(误差不超过 0.3)才要处理碰撞\r\n                let rigidBody = this.node.getComponent(RigidBody)!\r\n                rigidBody.sleep()\r\n                this.node.setParent(find('Models'), true) // 移到其他节点准备销毁\r\n\r\n                this.scheduleOnce(() => { // 三秒后销毁\r\n                    this.node.destroy()\r\n                }, 3)\r\n\r\n            } else {\r\n                return\r\n            }\r\n        }\r\n        \r\n    }\r\n\r\n\r\n\r\n}"]}